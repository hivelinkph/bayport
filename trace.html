<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Building Contour Tracer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #111; color: #fff; font-family: monospace; }
        .container { position: relative; display: inline-block; }
        img { max-width: 100vw; display: block; cursor: crosshair; }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .controls { padding: 16px; background: #222; position: fixed; bottom: 0; left: 0; right: 0; z-index: 10; }
        .controls button { padding: 8px 16px; margin: 0 4px; cursor: pointer; font-size: 14px; }
        .active-btn { background: #4CAF50; color: #fff; border: none; }
        .output { padding: 16px; background: #1a1a1a; max-height: 200px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; }
        .dot { fill: red; }
        .building-label { position: fixed; top: 10px; left: 10px; background: #4CAF50; padding: 8px 16px; font-size: 18px; font-weight: bold; z-index: 10; }
        polygon { stroke-width: 2; fill: rgba(255,255,255,0.1); }
        .poly-a { stroke: #FF4444; }
        .poly-b { stroke: #44FF44; }
        .poly-c { stroke: #4444FF; }
        .poly-d { stroke: #FFFF44; }
    </style>
</head>
<body>
    <div class="building-label" id="label">Select a building below, then click corners</div>
    <div class="container" id="container">
        <img src="assets/hero.png" id="img">
        <svg id="svg" viewBox="0 0 1536 1024"></svg>
    </div>
    <div class="controls">
        <button onclick="selectBuilding(0)" id="btn-0">Tower A</button>
        <button onclick="selectBuilding(1)" id="btn-1">Tower B</button>
        <button onclick="selectBuilding(2)" id="btn-2">Tower C</button>
        <button onclick="selectBuilding(3)" id="btn-3">Tower D</button>
        <button onclick="undoPoint()">Undo</button>
        <button onclick="clearCurrent()">Clear Current</button>
        <button onclick="exportAll()">Export All</button>
    </div>
    <div class="output" id="output">Click "Export All" to see polygon coordinates</div>

    <script>
        const colors = ['#FF4444', '#44FF44', '#4444FF', '#FFFF44'];
        const names = ['Tower A', 'Tower B', 'Tower C', 'Tower D'];
        const polyClasses = ['poly-a', 'poly-b', 'poly-c', 'poly-d'];
        const buildings = { 0: [], 1: [], 2: [], 3: [] };
        let current = null;

        const img = document.getElementById('img');
        const svg = document.getElementById('svg');
        const label = document.getElementById('label');
        const output = document.getElementById('output');

        function selectBuilding(id) {
            current = id;
            label.textContent = `Tracing: ${names[id]} (click building corners)`;
            label.style.background = colors[id];
            document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active-btn'));
            document.getElementById('btn-' + id).classList.add('active-btn');
        }

        img.addEventListener('click', (e) => {
            if (current === null) return;
            const rect = img.getBoundingClientRect();
            const scaleX = 1536 / rect.width;
            const scaleY = 1024 / rect.height;
            const x = Math.round((e.clientX - rect.left) * scaleX);
            const y = Math.round((e.clientY - rect.top) * scaleY);
            buildings[current].push([x, y]);
            redraw();
        });

        function undoPoint() {
            if (current !== null && buildings[current].length > 0) {
                buildings[current].pop();
                redraw();
            }
        }

        function clearCurrent() {
            if (current !== null) {
                buildings[current] = [];
                redraw();
            }
        }

        function redraw() {
            svg.innerHTML = '';
            for (let id = 0; id < 4; id++) {
                const pts = buildings[id];
                if (pts.length === 0) continue;

                // Draw polygon
                if (pts.length > 1) {
                    const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    poly.setAttribute('points', pts.map(p => p.join(',')).join(' '));
                    poly.classList.add(polyClasses[id]);
                    svg.appendChild(poly);
                }

                // Draw dots
                pts.forEach(([px, py]) => {
                    const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    c.setAttribute('cx', px);
                    c.setAttribute('cy', py);
                    c.setAttribute('r', 6);
                    c.setAttribute('fill', colors[id]);
                    svg.appendChild(c);
                });
            }
        }

        function exportAll() {
            let result = '';
            for (let id = 0; id < 4; id++) {
                const pts = buildings[id];
                if (pts.length === 0) continue;
                const pointsStr = pts.map(p => `${p[0]},${p[1]}`).join(' ');
                result += `<!-- ${names[id]} -->\n`;
                result += `<polygon points="${pointsStr}" />\n\n`;
            }
            if (!result) { alert('No points traced yet.'); return; }
            navigator.clipboard.writeText(result).then(() => {
                alert('Copied to clipboard! Paste it here in the chat.\n\nPreview:\n' + result);
            }).catch(() => {
                // Fallback: show in a prompt box so user can copy
                prompt('Copy the text below:', result);
            });
            output.textContent = result;
        }
    </script>
</body>
</html>
